<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starmap - Interactive 3D Star Viewer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-dark text-light">
    <div class="container-fluid">
        <header class="row bg-primary p-2 mb-2">
            <div class="col">
                <h1 class="text-center">Starmap: A Picture of the Felgenland Saga</h1>
            </div>
        </header>

        <!-- Quick Controls Bar -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="openControlWindow()">üéõÔ∏è Controls</button>
                                <button class="btn btn-success btn-sm" onclick="openStarDataWindow()">üìä Star Data</button>
                                <button class="btn btn-outline-info btn-sm" onclick="updateStarmap()" id="quickUpdate">Update Starmap</button>
                                <button class="btn btn-outline-warning btn-sm" onclick="resetView()">Reset View</button>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="small text-muted">Export:</span>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportImage('png')" title="Export as PNG">PNG</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportImage('jpg')" title="Export as JPG">JPG</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportImage('pdf')" title="Export as PDF">PDF</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden form elements for JavaScript compatibility -->
        <div style="display: none;">
            <input type="range" min="1" max="15" value="10" step="0.5" id="magLimit">
            <span id="magValue">10.0</span>
            <input type="range" min="100" max="2000" value="500" step="100" id="starCount">
            <span id="countValue">500</span>
            <input type="text" id="starSearch" placeholder="Star name...">
            <select id="spectralType">
                <option value="">All Types</option>
                <option value="O">O - Blue Giants</option>
                <option value="B">B - Blue-White</option>
                <option value="A">A - White</option>
                <option value="F">F - Yellow-White</option>
                <option value="G">G - Yellow (Sun-like)</option>
                <option value="K">K - Orange</option>
                <option value="M">M - Red</option>
            </select>
            <input type="range" id="galacticDistance" min="25" max="100" value="50">
            <span id="galacticDistanceValue">50</span>
            <button id="distanceToggle">üìè Start Distance Mode</button>
            <div id="distanceModeIndicator" style="display: none;">
                <small>üìç Distance mode active - click stars on map</small>
            </div>
            <input type="checkbox" id="politicalOverlay">
            <input type="checkbox" id="tradeRoutes">
            <input type="checkbox" id="territoryBorders">
            <input type="checkbox" id="galacticDirections">
            <input type="checkbox" id="galacticGrid">
            <input type="checkbox" id="includeUI" checked>
        </div>

        <!-- Full-Width Starmap -->
        <div class="row">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-body p-0">
                        <div id="starmap" style="height: 85vh;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <footer class="row mt-3">
            <div class="col">
                <div class="alert alert-info" id="statusBar">
                    Ready - Click "Update Starmap" to load stars
                </div>
            </div>
        </footer>
    </div>

    <!-- Planetary System Modal -->
    <div class="modal fade" id="systemModal" tabindex="-1" aria-labelledby="systemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="systemModalLabel">Planetary System View</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-md-8">
                            <div id="systemMap" style="height: 70vh; background-color: #000;"></div>
                        </div>
                        <div class="col-md-4 p-3">
                            <div id="systemInfo">
                                <h6 class="text-primary mb-3">System Information</h6>
                                <div id="starSystemDetails"></div>
                                <hr class="border-secondary">
                                <h6 class="text-success mb-3">Planets</h6>
                                <div id="planetList" class="system-planet-list">
                                    <!-- Planet list will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-info" onclick="toggleSystemAnimation()">
                        <span id="animationToggleText">‚ñ∂Ô∏è Start Animation</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nation Legend Modal -->
    <div class="modal fade" id="nationModal" tabindex="-1" aria-labelledby="nationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="nationModalLabel">üèõÔ∏è Fictional Nations</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="nationLegendContent">
                        <!-- Nation legend content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-success" onclick="focusOnNation()">Focus Selected</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/planetary_system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/starmap.js') }}"></script>
    <script>
        // Three-window system: Main Starmap, Controls, Star Data
        let controlWindow = null;
        let starDataWindow = null;
        
        // Open control window
        function openControlWindow() {
            if (controlWindow && !controlWindow.closed) {
                controlWindow.focus();
                return;
            }
            
            // Position controls window to the left of main window
            const left = Math.max(0, window.screenX - 620);
            const top = window.screenY;
            
            controlWindow = window.open(
                '/controls',
                'starmapControls',
                `width=600,height=${window.outerHeight},left=${left},top=${top},scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no,status=no`
            );
            
            if (controlWindow) {
                controlWindow.focus();
                
                // Wait for control window to load, then sync
                setTimeout(function() {
                    if (!controlWindow.closed) {
                        syncToControlWindow();
                    }
                }, 1000);
                
                // Check if window was blocked
                setTimeout(function() {
                    if (!controlWindow || controlWindow.closed) {
                        alert('Control window was blocked by popup blocker. Please allow popups for this site and try again.');
                        controlWindow = null;
                    }
                }, 100);
            } else {
                alert('Failed to open control window. Please check your browser settings and allow popups for this site.');
            }
        }
        
        // Open star data window
        function openStarDataWindow() {
            if (starDataWindow && !starDataWindow.closed) {
                starDataWindow.focus();
                return;
            }
            
            // Position star data window to the right of main window
            const left = window.screenX + window.outerWidth;
            const top = window.screenY;
            
            starDataWindow = window.open(
                '/stardata',
                'starmapStarData',
                `width=400,height=${window.outerHeight},left=${left},top=${top},scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no,status=no`
            );
            
            if (starDataWindow) {
                starDataWindow.focus();
                
                // Check if window was blocked
                setTimeout(function() {
                    if (!starDataWindow || starDataWindow.closed) {
                        alert('Star Data window was blocked by popup blocker. Please allow popups for this site and try again.');
                        starDataWindow = null;
                    }
                }, 100);
            } else {
                alert('Failed to open Star Data window. Please check your browser settings and allow popups for this site.');
            }
        }
        
        // Sync current settings to control window
        function syncToControlWindow() {
            if (controlWindow && !controlWindow.closed) {
                controlWindow.postMessage({
                    action: 'syncControls',
                    data: {
                        magLimit: document.getElementById('magLimit')?.value || 10,
                        starCount: document.getElementById('starCount')?.value || 500,
                        galacticDistance: document.getElementById('galacticDistance')?.value || 50,
                        politicalOverlay: typeof politicalOverlayActive !== 'undefined' ? politicalOverlayActive : false,
                        tradeRoutes: typeof tradeRoutesActive !== 'undefined' ? tradeRoutesActive : false,
                        territoryBorders: typeof territoryBordersActive !== 'undefined' ? territoryBordersActive : false,
                        galacticDirections: typeof galacticDirectionsActive !== 'undefined' ? galacticDirectionsActive : false,
                        galacticGrid: typeof galacticGridActive !== 'undefined' ? galacticGridActive : false
                    },
                    source: 'main'
                }, '*');
            }
        }
        
        // Send star data to star data window
        function sendToStarDataWindow(action, data) {
            if (starDataWindow && !starDataWindow.closed) {
                starDataWindow.postMessage({
                    action: action,
                    data: data,
                    source: 'main'
                }, '*');
            }
        }
        
        // Listen for messages from child windows
        window.addEventListener('message', function(event) {
            const { action, data, source } = event.data;
            
            if (source === 'controls') {
                handleControlMessage(action, data);
            } else if (source === 'stardata') {
                handleStarDataMessage(action, data);
            }
        });
        
        function handleControlMessage(action, data) {
            switch (action) {
                case 'requestSync':
                    syncToControlWindow();
                    break;
                case 'updateStarmap':
                    if (typeof updateStarmap === 'function') updateStarmap();
                    break;
                case 'searchStars':
                    const searchInput = document.getElementById('starSearch');
                    if (searchInput && data.query !== undefined) {
                        searchInput.value = data.query;
                    }
                    if (typeof searchStars === 'function') searchStars();
                    break;
                case 'filterBySpectralType':
                    if (typeof filterBySpectralType === 'function') filterBySpectralType();
                    break;
                case 'toggleDistanceMeasurement':
                    if (typeof toggleDistanceMeasurement === 'function') toggleDistanceMeasurement();
                    break;
                case 'togglePoliticalOverlay':
                    // Update the hidden checkbox state
                    const politicalCheckbox = document.getElementById('politicalOverlay');
                    if (politicalCheckbox && data.checked !== undefined) {
                        politicalCheckbox.checked = data.checked;
                    }
                    if (typeof togglePoliticalOverlay === 'function') togglePoliticalOverlay();
                    break;
                case 'toggleTradeRoutes':
                    const tradeCheckbox = document.getElementById('tradeRoutes');
                    if (tradeCheckbox && data.checked !== undefined) {
                        tradeCheckbox.checked = data.checked;
                    }
                    if (typeof toggleTradeRoutes === 'function') toggleTradeRoutes();
                    break;
                case 'toggleTerritoryBorders':
                    const borderCheckbox = document.getElementById('territoryBorders');
                    if (borderCheckbox && data.checked !== undefined) {
                        borderCheckbox.checked = data.checked;
                    }
                    if (typeof toggleTerritoryBorders === 'function') toggleTerritoryBorders();
                    break;
                case 'toggleGalacticDirections':
                    const directionsCheckbox = document.getElementById('galacticDirections');
                    if (directionsCheckbox && data.checked !== undefined) {
                        directionsCheckbox.checked = data.checked;
                    }
                    if (typeof toggleGalacticDirections === 'function') toggleGalacticDirections();
                    break;
                case 'toggleGalacticGrid':
                    const gridCheckbox = document.getElementById('galacticGrid');
                    if (gridCheckbox && data.checked !== undefined) {
                        gridCheckbox.checked = data.checked;
                    }
                    if (typeof toggleGalacticGrid === 'function') toggleGalacticGrid();
                    break;
                case 'updateGalacticDistance':
                    if (typeof updateGalacticDistance === 'function') updateGalacticDistance();
                    break;
                case 'resetView':
                    if (typeof resetView === 'function') resetView();
                    break;
                case 'clearHighlight':
                    if (typeof clearHighlight === 'function') clearHighlight();
                    sendToStarDataWindow('clearStarData', {});
                    break;
                case 'exportCSV':
                    if (typeof exportCSV === 'function') exportCSV();
                    break;
                case 'exportImage':
                    if (typeof exportImage === 'function') exportImage(data.format);
                    break;
                case 'showNationLegend':
                    if (typeof showNationLegend === 'function') showNationLegend();
                    break;
                case 'toggleSystemView':
                    if (typeof toggleSystemView === 'function') toggleSystemView();
                    break;
                case 'updateSliderValue':
                    const element = document.getElementById(data.id);
                    if (element) {
                        element.value = data.value;
                        
                        // Update corresponding display elements
                        if (data.id === 'magLimit') {
                            const display = document.getElementById('magValue');
                            if (display) display.textContent = data.value;
                        } else if (data.id === 'starCount') {
                            const display = document.getElementById('countValue');
                            if (display) display.textContent = data.value;
                        } else if (data.id === 'galacticDistance') {
                            const display = document.getElementById('galacticDistanceValue');
                            if (display) display.textContent = data.value;
                        }
                    }
                    break;
            }
        }
        
        function handleStarDataMessage(action, data) {
            switch (action) {
                case 'requestStarDataSync':
                    // Send any current star data to the star data window
                    break;
                case 'focusOnStar':
                    // Focus on a specific star in the starmap
                    if (data.star && typeof focusOnStar === 'function') {
                        focusOnStar(data.star);
                    }
                    break;
                case 'clearHighlight':
                    if (typeof clearHighlight === 'function') clearHighlight();
                    break;
                case 'toggleSystemView':
                    if (typeof toggleSystemView === 'function') toggleSystemView();
                    break;
            }
        }
        
        // Override starmap functions to send data to star data window
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for starmap.js to load, then wrap its functions
            setTimeout(function() {
                // Store original functions
                const originalShowStarInfo = window.showStarInfo;
                const originalShowSearchResults = window.showSearchResults;
                const originalShowPlanetInfo = window.showPlanetInfo;
                
                // Override to send to star data window
                if (originalShowStarInfo) {
                    window.showStarInfo = function(starData) {
                        // Call original function for any local needs
                        originalShowStarInfo(starData);
                        
                        // Send to star data window
                        sendToStarDataWindow('updateStarInfo', {
                            star: starData,
                            html: document.getElementById('starDetails')?.innerHTML || ''
                        });
                    };
                }
                
                if (originalShowSearchResults) {
                    window.showSearchResults = function(results) {
                        // Call original function
                        originalShowSearchResults(results);
                        
                        // Send to star data window
                        sendToStarDataWindow('updateSearchResults', {
                            results: results,
                            html: document.getElementById('searchResultsList')?.innerHTML || ''
                        });
                    };
                }
                
                if (originalShowPlanetInfo) {
                    window.showPlanetInfo = function(planetData) {
                        // Call original function
                        originalShowPlanetInfo(planetData);
                        
                        // Send to star data window
                        sendToStarDataWindow('updatePlanetInfo', {
                            planets: planetData,
                            html: document.getElementById('planetDetails')?.innerHTML || '',
                            title: document.getElementById('planetSystemTitle')?.textContent || 'Planetary System'
                        });
                    };
                }
            }, 1000);
        });
    </script>
</body>
</html>